</!DOCTYPE html>
<html>
    <head>
    <!--
    todo
    - local storage for more than one book
    - gentle introduction for first time use (/ demo mode)
    - mobile interface tweaks
    - touch interface for loading text
    - change font size

    - Content retrieval methods
       - url
       - file open
       - rss (?)
       - bookmarklet
    - Support other formats
       - html
       - epub
    -->
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="TBD">
        <meta name="keywords" content="TBD">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" sizes="16x16 32x32 64x64" href="../favicon.ico">
        <link rel="icon" sizes="228x228" href="./favicon-228.png">
        <link rel="icon" sizes="195x195" href="./favicon-195.png">
        <link rel="icon" sizes="152x152" href="./favicon-152.png">
        <link rel="icon" sizes="144x144" href="./favicon-144.png">
        <link rel="icon" sizes="128x128" href="./favicon-128.png">
        
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="./iosfavicon-152.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="./iosfavicon-144.png">
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="./iosfavicon-120.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="./iosfavicon-114.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="./iosfavicon-72.png">
        <link rel="apple-touch-icon-precomposed" href="./iosfavicon-57.png">
        <link rel="shortcut icon" href="./favicon.ico">

        <title>WordyWordy</title>
        <style>
            @font-face {
                font-family      : "Roboto";
                font-weight      : lighter;
                font-style       : normal;
                src: url('font/Roboto-Thin.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : lighter;
                font-style       : italic;
                src: url('font/Roboto-ThinItalic.ttf');
            }
            @font-face {
                font-family      : "Roboto-normal";
                font-weight      : normal;
                font-style       : normal;
                src: url('font/Roboto-Light.ttf');
            }
            @font-face {
                font-family      : "Roboto-normal";
                font-weight      : normal;
                font-style       : italic;
                src: url('font/Roboto-LightItalic.ttf');
            }
            @font-face {
                font-family      : "dyslexic";
                font-weight      : normal;
                font-style       : normal;
                src: url('font/OpenDyslexicAlta-Regular.otf');
            }
            body, span, div, textarea {
                margin: 0;
                border: 0;
                padding: 0;
            }
            body {
                background-color: rgba(251, 240, 217, 1);
                color: rgba(95, 75, 50, 1);
                font-family: Roboto, sans-serif;
                font-weight: lighter;
                font-size: 48pt;
            }
            div.outputwrap {
                width:100%;
                position: absolute;
                text-align: center;
                top: 40%;
                background-color: inherit; 
            }
            @-webkit-keyframes openmouth {
                0% {}
                100% {border-radius:1em; border-width: 0.2em; } 
            }
            @keyframes openmouth {
                0% {}
                100% {border-radius:1em; border-width: 0.2em; } 
            }
            .openmouth {
                -webkit-animation-name: openmouth;
                -webkit-animation-duration: 1s;
                -webkit-animation-iteration-count:1;
                -webkit-animation-timing-function: linear;
                -webkit-animation-direction: alternate;
                -webkit-animation-fill-mode:forwards;
                animation-name: openmouth;
                animation-duration: 1s;
                animation-iteration-count:1;
                animation-timing-function: linear;
                animation-direction: alternate;
                animation-fill-mode:forwards;
            }
            .smile {
                -webkit-animation-name: openmouth;
                -webkit-animation-duration: 1.0s;
                -webkit-animation-iteration-count:2;
                -webkit-animation-timing-function: linear;
                -webkit-animation-direction: alternate;
                animation-name: openmouth;
                animation-duration: 1.0s;
                animation-iteration-count:2;
                animation-timing-function: linear;
                animation-direction: alternate;
            }
            @-webkit-keyframes reload {
                0% {}
                85% {
                    padding: 0 0 0.2em 25%;
                    border-radius: 0 0 0 1em;
                }
                100% {}
            }
            @keyframes reload {
                0% {}
                85% {
                    padding: 0 0 0.2em 25%;
                    border-radius: 0 0 0 1em;
                }
                100% {}
            }
            .reload {
                -webkit-animation-name: reload;
                -webkit-animation-duration: 950ms;
                -webkit-animation-iteration-count: 1;
                -webkit-animation-timing-function: linear;
                animation-name: reload;
                animation-duration: 950ms;
                animation-iteration-count: 1;
                animation-timing-function: linear;
            }
            @-webkit-keyframes breathe-border {
                0% { border-color: currentColor; } 
                40% { border-color: rgba(128, 128, 128, 1); }
                50% { border-color: rgba(128, 128, 128, 1); }
                60% { border-color: rgba(128, 128, 128, 1); }
                100% { border-color: currentColor; }
            }
            @keyframes breathe-border {
                0% { border-color: currentColor; }
                40% { border-color: rgba(128, 128, 128, 1); }
                50% { border-color: rgba(128, 128, 128, 1); }
                60% { border-color: rgba(128, 128, 128, 1); }
                100% { border-color: currentColor; }
            }
            .breathing {
                /*
                 nice idea. Strangely, saps a lot of energy.

                -webkit-animation-name: breathe-border;
                -webkit-animation-duration: 6s;
                -webkit-animation-iteration-count: infinite;
                -webkit-animation-timing-function: ease-in-out;
                animation-name: breathe-border;
                animation-duration: 6s;
                animation-iteration-count: infinite;
                animation-timing-function: ease-in-out;
                */
            }
            .playing {
            }
            #__output {
                padding: 0 0.6em 0.2em 0.6em;
                border-bottom: 3px solid currentColor; /*accent*/
                background-color: inherit; 
            }
            #__percentage {
                background-color:currentColor; /*accent*/
                opacity: 0.5;
                position:fixed;
                bottom:0;
                left:0;
                text-align: left;
                height: 0.2em;
                width: 0;
            }
            #__droparea {
                position: fixed;
                z-index: 1;
                background-color: transparent;
                color: transparent;
                width: 100%;
                height: 100%;
                resize: none;
                cursor: default;
            }
            #__status {
                width: 100%;
                position: absolute;
                text-align: center;
                display: none;
                font-size: 0.4em;
            }
            #__status div {
                color: inherit; /*accent*/
                opacity: 0.5;
            }
            #__status table {
                color: inherit;
                width: 100%;
            }
            #__status td {
            }
            #__status td:first-child{
                font-style: italic;
                padding-right: 1em;
                text-align: right;
            }
            #__toast {
                position: absolute;
                bottom: 20%;
                margin-top: 1.4em;
                width: 100%;
                height: 1.4em;
                background-color: transparent;
                padding-top: 0.4em;
                /* color: inherit;*/ /*accent*/
                opacity: 0.5;
                text-align: center;
                display: none;
            }

            @keyframes fadeaway {
                100% {opacity: 0}
            }
            @-webkit-keyframes fadeaway {
                0% {}
                100% {opacity: 0}
            }
            .fade-away {
                -webkit-animation-name: fadeaway;
                -webkit-animation-duration: 0.3s;
                -webkit-animation-timing-function: ease-in;
                -webkit-animation-fill-mode : forwards;
                animation-name: fadeaway;
                animation-duration: 0.3s;
                animation-timing-function: ease-in;
                animation-fill-mode : forwards;
            }
        </style>
    </head>
    <body> 
        <textarea id="__droparea"></textarea>
        <div class="outputwrap">
            <span id="__output" class="breathing"></span>
        </div>
        <span id="__status">
            <div>
            <table>
                <tr>
                    <td>Document</td>
                    <td>
                        <span id="__documentTitle"></span>
                    </td>
                </tr>
                <tr>
                    <td>Selected speed</td>
                    <td>
                        <span id="__selectedSpeed"></span>
                        <span title="words per minute">wpm</span>
                    </td>
                </tr>
                <tr>
                    <td>Position</td>
                    <td>
                        <span id="__position"></span> of
                        <span id="__wordsTotal"></span> words
                        (<span id="__positionInPercent"></span>%)
                    </td>
                </tr>
                <tr>
                    <td>Words displayed</td>
                    <td>
                        <span id="__wordsPlayed"></span>
                        @<span id="__actualSpeed"></span>
                        <span title="words per minute">wpm</span>
                    </td>
                </tr>
                <tr>
                    <td>&#x025F7; spent + left = total</td>
                    <td>
                        <span id="__timeElapsed"></span> + 
                        <span id="__timeToGo"></span> = 
                        <span id="__timeTotal"></span>
                    </td>
                </tr>
            </table>
            </div>
        </span>
        <span id="__toast"></span>
        <div id="__percentage"></div>
    </body>
    <script>

var words = function () {
    var MIN_SPEED     = 60; // words per minute
    var DEFAULT_SPEED = 300 /// words per minute
    var MAX_SPEED     = 600; // words per minute

    var MIN_DELAY               = 100;
    var LETTER_DELAY            = 30;
    var CJK_DELAY               = 250;
    var NUMBER_DELAY            = 50;
    var CAPITALS_DELAY          = 50;
    var QUOTE_DELAY             = 40;
    var BRACKET_DELAY           = 100;
    var SHORT_PUNCTUATION_DELAY = 180;
    var LONG_PUNCTUATION_DELAY  = 250;
    var SENTENCE_END_DELAY      = 400;
    var PARAGRAPH_END_DELAY     = 250;
     
    var rAry           = [];
    var rSelectedSpeed = DEFAULT_SPEED; // words per minute
    var rPosition      = 0; // word
    var MILLISECONDS_PER_MINUTE = 60000; //milliseconds
    var MAX_SKIP_AHEAD = 42; // words
    var rMinDelay      = MIN_DELAY*speed2Base(rSelectedSpeed); 
    var rLetterDelay   = LETTER_DELAY*speed2Base(rSelectedSpeed);
    var rRe2delay      = [];

         
    /*
     * SPACES_RE includes all spaces as mentioned
     * in https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp
     * under \s, except the non-breaking space character, which is misused
     * in the time algorithm.
     */
    var SPACES_RE = new RegExp("[ \f\n\r\t\v\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+");
    var SENTENCE_END_CHARS = "\.\?\!\u3002\uFF1F";
    var SENTENCE_END_RE = new RegExp("["+SENTENCE_END_CHARS+"]");

    /*
     * Picture scripts (e.g. Chinese, Korean) need a different treatment.
     * These unicode code pointranges come from
     * http://www.unicode.org/Public/UCD/latest/ucd/Scripts.txt
     * 
     * Japanese Hiragana and Katakana have been skipped intentionally as
     * these are actually 
     * 
     */ 
    var HAN_CHAR  = "\u2E80-\u2E99|\u2E9B-\u2EF3|\u2F00-\u2FD5|\u3005|\u3007|\u3021-\u3029|\u3038-\u303A|\u303B|\u3400-\u4DB5|\u4E00-\u9FCC|\uF900-\uFA6D|\uFA70-\uFAD9";
    var YI_CHAR   = "\uA000-\uA014|\uA015|\uA016-\uA48C|\uA490-\uA4C6";
    var HANGUL_CHAR = "\u1100-\u11FF|\u302E-\u302F|\u3131-\u318E|\u3200-\u321E|\u3260-\u327E|\uA960-\uA97C|\uAC00-\uD7A3|\uD7B0-\uD7C6|\uD7CB-\uD7FB|\uFFA0-\uFFBE|\uFFC2-\uFFC7|\uFFCA-\uFFCF|\uFFD2-\uFFD7|\uFFDA-\uFFDC";
    var CJK_CHAR  = HAN_CHAR + "|" + YI_CHAR + "|" + HANGUL_CHAR;
    var CJK_RE    = new RegExp("(["+ CJK_CHAR +"])", "g");

    function _init(pString, pPosition){
        rAry = pString
                    .replace(/[\-]{4,}/g, "---") //
                    .replace(/[_]{4,}/g, "___") //
                    .replace(/[=]{4,}/g, "===") //
                    .replace(/[+]{4,}/g, "+++") //
                    .replace(/[~]{4,}/g, "~~~") //
                    .replace(/\.\.\./g, "…") //
                    .replace(/([a-zA-Z])([\(\)\[\]\{\}\.\?\!:;\-,…\/|\u2010-\u2015]{1,2})([a-zA-Z])/g, "$1$2 $3") //
                    .replace(/&nbsp;/g, " ") //
                    .replace(/\u00A0/g, " ") //
                    .replace(/\r\n/g, "\n") //
                    .replace(/[\n]{2,}/g, "\u00A0 ") // so we can distinguish "paragraph" ends
                    .replace(CJK_RE, " $1") //
                    .split(SPACES_RE);

        _setPositionSafe(pPosition);
    }

    function _sanitizeNumber(pThing, pDefault){
        if (typeof pThing  === 'string') {
            pThing = parseInt(pThing);
        }
        if (typeof pThing !== 'number' || pThing === NaN ){
            pThing = pDefault;
        }
        return pThing;
    }

    function _setPositionSafe(pPosition){
        pPosition = _sanitizeNumber(pPosition, 0);
        _setPosition(pPosition);
    }
    function _incPosition(pAmount) {
        _setPosition(rPosition + pAmount);
    }

    function _decPosition(pAmount) {
        _setPosition(rPosition - pAmount);
    }

    function _setPosition(pPosition){
        rPosition = Math.min(_getLength(), Math.max(0, pPosition));
    }

    function _getPosition(){
        return rPosition;
    }

    function _getPercentage(){
        return rAry.length > 0 ? 100*(rPosition/rAry.length) : 0;
    }

    function _setSpeed(pSpeed) {

        pSpeed         = _sanitizeNumber(pSpeed, DEFAULT_SPEED);

        rSelectedSpeed = Math.min(MAX_SPEED, Math.max(MIN_SPEED, pSpeed));
        var lBase      = speed2Base(pSpeed);
        rMinDelay      = MIN_DELAY*lBase;
        rLetterDelay   = LETTER_DELAY*lBase;

        rRe2delay = [
            {re: SENTENCE_END_RE,  delay: SENTENCE_END_DELAY*lBase}, 
            {re: /[;:…–\u00B7|\u2010-\u2015]/,
                                   delay: LONG_PUNCTUATION_DELAY*lBase},
            {re: /[-,\/\uFF0C]/,   delay: SHORT_PUNCTUATION_DELAY*lBase},
            {re: /[\(\)\[\]\{\}]/, delay: BRACKET_DELAY*lBase},
            {re: /["'‘’“”]/,       delay: QUOTE_DELAY*lBase},
            {re: /\u00A0/,         delay: PARAGRAPH_END_DELAY*lBase},
            {re: /[0-9=\+]/,       delay: NUMBER_DELAY*lBase},
            {re: /[A-Z]/,          delay: CAPITALS_DELAY*lBase},
            {re: CJK_RE,           delay: CJK_DELAY*lBase}
        ];
    }

    function _getSpeed(){
        return rSelectedSpeed;
    }

    function _incSpeed(pAmount){
        _setSpeed(rSelectedSpeed + pAmount);
    }

    function _decSpeed(pAmount){
        _setSpeed(rSelectedSpeed - pAmount);
    }

    function _gotoStartOfSentence() {
        var lFound = false;
        if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
            rPosition--;
        }
        var lLimit = Math.max(rPosition - MAX_SKIP_AHEAD, 0);
        for (rPosition; (!lFound && (rPosition > lLimit)); rPosition--){
            if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
                lFound = true;
                rPosition += 2;
            }
        }
    }

    function _gotoEndOfSentence() {
        var lFound = false;
        var lLimit = Math.min(rPosition + MAX_SKIP_AHEAD, rAry.length);
        for (rPosition; (!lFound && (rPosition < lLimit)); rPosition++){
            if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
                lFound = true;
                rPosition -= 1;
            }
        }
    }

    function _getLength(){
        return rAry.length;
    }

    function _getCurrentWord(){
        return rAry[rPosition];
    }

    function regexp2duration(pChar){
        var lRetval = 0;
        var lMatched = false;
        for (var i = 0;(i < rRe2delay.length && !lMatched); i++){
            if (pChar.match(rRe2delay[i].re)){
                lRetval += rRe2delay[i].delay;
                lMatched = true;
            }
        }
        if (!lMatched){
            lRetval += rLetterDelay;
        }
        return lRetval;
    }

    function speed2Base (pSpeed) {
        return (MILLISECONDS_PER_MINUTE/pSpeed)/280;// 280 = min delay + 6xletter delay
    }
    
    function _getDisplayTime() {
        return _determineDisplayTime(_getCurrentWord());
    }

    function _determineDisplayTime(pWord){
        var lRetval = 0;
        if (pWord){
            lRetval = rMinDelay;
            for (var i = 0; i < pWord.length; i++){
                lRetval += regexp2duration(pWord[i]);
            }
        }
        return lRetval;
    }

    function _getEstimatedTimeToGo(){
        return MILLISECONDS_PER_MINUTE*(rAry.length - rPosition)/rSelectedSpeed;
    }

    return {
        init: _init,
        getSpeed: _getSpeed,
        setSpeed: _setSpeed,
        incSpeed: _incSpeed,
        decSpeed: _decSpeed,
        getCurrentWord: _getCurrentWord,
        getDisplayTime: _getDisplayTime,
        getLength: _getLength,
        getPercentage: _getPercentage,
        getEstimatedTimeToGo: _getEstimatedTimeToGo,
        getPosition: _getPosition,
        setPosition: _setPosition,
        incPosition: _incPosition,
        decPosition: _decPosition,
        gotoEndOfSentence: _gotoEndOfSentence,
        gotoStartOfSentence: _gotoStartOfSentence
    };
}();

var timefmt = function (){ 

    var MILLISECONDS_PER_SECOND = 1000; // millseconds
    var SECONDS_PER_MINUTE      = 60; // seconds
    var MINUTES_PER_HOUR        = 60; // minutes
    var HOURS_PER_DAY           = 24; // hours
    
    function millisToTimeStruct (pMilliSeconds) {
        var lSeconds = pMilliSeconds/ MILLISECONDS_PER_SECOND;
        var lMinutes = Math.max(0, lSeconds/ SECONDS_PER_MINUTE); 
        var lHours   = Math.max(0, lMinutes/ MINUTES_PER_HOUR);
        var lDays    = Math.max(0, lHours/ HOURS_PER_DAY);

        var lMilliSeconds = Math.max(0, pMilliSeconds - (Math.floor(lSeconds)*MILLISECONDS_PER_SECOND));
        lSeconds     = Math.max(0, lSeconds - (Math.floor(lMinutes) * SECONDS_PER_MINUTE));
        lMinutes     = Math.max(0, lMinutes - (Math.floor(lHours) * MINUTES_PER_HOUR));
        lHours       = Math.max(0, lHours - (Math.floor(lDays) * HOURS_PER_DAY));

        return {
            "days"         : Math.floor(lDays),
            "hours"        : Math.floor(lHours),
            "minutes"      : Math.floor(lMinutes),
            "seconds"      : Math.floor(lSeconds),
            "milliseconds" : lMilliSeconds
        };  
    }   

    function formatTimeBlob (pInt) {
        if (pInt < 10) {
            return "0" + pInt;
        }   
        return pInt.toString();
    }   
        
    return {
        formatTime : function (pMilliSeconds, pShowMillis) {
            var lTimeStruct = millisToTimeStruct(pMilliSeconds);
            if (!pShowMillis) { pShowMillis = false; }
            var lRetval =  
                   (lTimeStruct.hours > 0 ? lTimeStruct.hours + ":" : "") +
                   formatTimeBlob (lTimeStruct.minutes) + ":" +
                   formatTimeBlob (lTimeStruct.seconds) +
                   (pShowMillis ? "." + lTimeStruct.milliseconds: "");
            return lRetval;
        }   
    };  
}();

var paramslikker = function(){
    function _getParams(pSearchString) {
        var lRetval = {};
        if (pSearchString) {
            var lKeyValAry;
            //  search string always starts with a "?" - skip this
            pSearchString.slice(1).split("&").forEach(function(pKeyVal){
                lKeyValAry = pKeyVal.split("=");
                if (2 === lKeyValAry.length) {
                    lRetval[lKeyValAry[0]] = unescape(lKeyValAry[1]);
                }
            });
        }
        return lRetval;
    }

    return {
        getParams : _getParams
    };
}();

function Stopwatch () {
    this.reset = function () {
        this.state = "paused"; // running, paused
        this.startTime = Date.now();
        this.pauseStartTime = this.startTime;
        this.cumulativePauses = 0;
    };

    // constructor hack
    this.reset();
}

Stopwatch.prototype.start = function () {
    this.state             = "running";
    this.startTime         = Date.now();
    this.pauseStartTime    = this.startTime;
    this.cumulativePauses  = 0;
};

Stopwatch.prototype.resume = function () {
    this.state             = "running";
    var lPause             = (Date.now() - this.pauseStartTime);
    this.cumulativePauses += lPause;
};

Stopwatch.prototype.pause = function () {
    if (this.state !== "paused"){
        this.state             = "paused";
        this.pauseStartTime    = Date.now();
    }
};

Stopwatch.prototype.getTimeElapsed = function () {
    if (this.state === "running"){
        return Date.now() - this.startTime - this.cumulativePauses;
    } else {
        return this.pauseStartTime - this.startTime - this.cumulativePauses;
    }
};

var ctrl = function () {
    var rPlaying     = false;
    var rWordsPlayed = 0;

    var rWordTimer;
    var rToastTimer;
    var rShowStatus    = false;
    var rLoop          = false;
    var rDocumentTitle = "";
    var rAppName       = "WordyWordy";

    var SPACE_KEY    = 32;
    var ENTER_KEY    = 13;
    var LEFT_KEY     = 37;
    var UP_KEY       = 38;
    var RIGHT_KEY    = 39;
    var DOWN_KEY     = 40;
    var BACKSPACE_KEY = 8;
    var SECTION_KEY_FF = 0;
    var SECTION_KEY  = 192; // on FF this is the ` (backquote)
                           // in safari both the § and ` key listen to 192
    var A_KEY = 65;
    var B_KEY = 66;
    var C_KEY = 67;
    var D_KEY = 68;
    var E_KEY = 69;
    var H_KEY = 72;
    var J_KEY = 74;
    var K_KEY = 75;
    var L_KEY = 76;
    var Q_KEY = 81;
    var S_KEY = 83;
    var T_KEY = 84;
    var W_KEY = 87;
    var PAGEUP_KEY   = 33;
    var PAGEDOWN_KEY = 34;
    var HOME_KEY     = 36;
    var END_KEY      = 35;
    // var ESC_KEY = 27;
    var COMMA_KEY    = 188;
    var DOT_KEY      = 190;
    var SLASH_KEY    = 191;
    var ZERO_KEY     = 48;
    var ONE_KEY      = 49;
    var TWO_KEY      = 50;
    var THREE_KEY    = 51;
    var FOUR_KEY     = 52;
    var FIVE_KEY     = 53;
    var SIX_KEY      = 54;
    var SEVEN_KEY    = 55;
    var EIGHT_KEY    = 56;
    var NINE_KEY     = 57;

    var CH_STOPWATCH    = '\u23F1';
    var CH_TIMERCLOCK   = '\u25F7'; // or '\u23F2' which is not availble in std font
    var CH_PLAY         = '\u25B7'; // or \u23F5 not available in std font
    var CH_PAUSE        = '\u25A1'; 
    var CH_STOP         = '\u25A1';// '\u23F8' not available in std font
    var CH_FASTFORWARD  = '\u23E9';
    var CH_FASTBACKWARD = '\u23EA';
    var CH_INCREASE     = '\u25B3'; // or '\u23F6' which is not available in std font
    var CH_DECREASE     = '\u25BD'; // or '\u23F7' which is not available in std font


    var MILLISECONDS_PER_MINUTE = 60000; // milliseconds
    var INITIAL_DISPLAY_DELAY   = 1000;  // milliseconds
    var TOAST_FADE_TIME         = 2200;  // milliseconds

    /* localStorage keys */
    var LS_KEY_BUFFER    = 'buffer';
    var LS_KEY_TITLE     = 'title';
    var LS_KEY_POSITION  = 'position';
    var LS_KEY_SPEED     = 'speed';
    var LS_KEY_THEME     = 'theme';

    var rStopwatch = new Stopwatch();
    var rReader    = new FileReader();
    var rParams    = paramslikker.getParams(window.location.search);
    

    function playString(pString) {
        rWordsPlayed = 0;
        words.init(pString, 0);
        updateTimeToGo();
        rStopwatch.start();
        play();
    }

    function outputNextWord(){
        if (rWordTimer){
            window.clearTimeout(rWordTimer);
        }
        if (rLoop === true) {
            window.__output.className = "playing";
        }

        if (rPlaying){
            if (words.getPosition() < words.getLength()){
                displayWord(words.getCurrentWord(), true);
                rWordTimer = window.setTimeout(outputNextWord, words.getDisplayTime());
                words.incPosition(1);
            } else if (rLoop === true) {
                words.setPosition(0);
                window.__output.className = "reload";
                rWordTimer = window.setTimeout(outputNextWord, 1000);
            } else {
                window.__output.innerHTML = "";
                window.__output.className = "smile";
                pause();
            }
        }
    }

    function displayWord(pWord, pAddsToPlayedCount){
        if (undefined !== pWord) {
            window.__output.innerHTML = pWord;
            window.__percentage.setAttribute("style",
                            "width: " + words.getPercentage() + "%;");
            if (rShowStatus){
                updateStatus();
            } 
            if (pAddsToPlayedCount) {
                rWordsPlayed++;
            }
        }
    }

    function updateStatus() {
        var lTimeElapsed = rStopwatch.getTimeElapsed();
        var lMinutesRead = (lTimeElapsed)/MILLISECONDS_PER_MINUTE;

        var lActualSpeed = lMinutesRead > 0 ? rWordsPlayed/ lMinutesRead : 0;
        var lTimeToGo    = words.getEstimatedTimeToGo(); 
        var lTimeTotal   = lTimeElapsed + lTimeToGo;

        window.__documentTitle.innerHTML = rDocumentTitle;
        window.__selectedSpeed.innerHTML = words.getSpeed();
        window.__actualSpeed.innerHTML   = lActualSpeed.toFixed(0);
        window.__position.innerHTML      =  words.getPosition();
        window.__positionInPercent.innerHTML = words.getPercentage().toFixed(1);
        window.__wordsPlayed.innerHTML   =  rWordsPlayed;
        window.__wordsTotal.innerHTML    = words.getLength();

        window.__timeElapsed.innerHTML   = timefmt.formatTime(lTimeElapsed);
        window.__timeToGo.innerHTML      = timefmt.formatTime(lTimeToGo);
        window.__timeTotal.innerHTML     = timefmt.formatTime(lTimeTotal);
    }

    function toggleStatus(){
        rShowStatus = !rShowStatus;
        if (rShowStatus){
            window.__status.style.display = "inline";
            updateStatus();
        } else {
            window.__status.style.display = "none";
        }
    }

    function play() {
        rStopwatch.resume();
        rPlaying = true;
        window.__output.className = "playing";
        document.title = CH_PLAY + " " + rDocumentTitle + " - " + rAppName;
        outputNextWord();
    }

    function pause() {
        rStopwatch.pause();
        rPlaying = false;
        // __output.className = "breathing";
        document.title = rDocumentTitle + " - " + rAppName;
        if (localStorageOK()) {
            localStorage.setItem("position", words.getPosition());
        }
    }

    function togglePlay(){
        rPlaying = !rPlaying;
        if(rPlaying) {
            play();
        } else {
            pause();
        }
    }

    function toast(pString){
        if (rToastTimer){
            window.clearTimeout(rToastTimer);
        }
        window.__toast.style.display = "block";
        window.__toast.className = "";
        window.__toast.innerHTML = pString;
        rToastTimer = window.setTimeout(function(){
                    window.__toast.className = "fade-away";
                },TOAST_FADE_TIME);
    }

    function setDocumentTitle(pString) {
        rDocumentTitle = pString;

        if (localStorageOK()){
            localStorage.setItem(LS_KEY_TITLE, pString);
        }
    }

    function updateNavigation (pPause) {
        if (pPause) {
            pause();
        }
        displayWord(words.getCurrentWord(), false);
        toast(words.getPercentage().toFixed(1) + "%");
    }

    function updateSpeed (pSpeed) {
        updateStatus();
        toast(pSpeed + " wpm");
        if (localStorageOK()) {
            localStorage.setItem(LS_KEY_SPEED, pSpeed);
        }
    }

    function updateTimeToGo() {
        toast(CH_TIMERCLOCK + " -" + timefmt.formatTime(words.getEstimatedTimeToGo()));
    }

    function setTheme(pThemeNumber){
        var lThemes = [
            {
                name: "Night - low contrast", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(60, 60, 60, 1)",
                accentColor: "rgba(60, 60, 60, 0.5)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "Sepia", 
                backgroundColor: "rgba(251, 240, 217, 1)",
                color: "rgba(95, 75, 50, 1)",
                accentColor: "rgba(95, 75, 50, 0.5)",
                fontFamily: "Roboto, sans-serif"
            },
            {
                name: "Day", 
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(0, 0, 0, 1)",
                accentColor: "rgba(0, 0, 0, 0.5)",
                fontFamily: "Roboto, sans-serif"
            },
            {
                name: "Night", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(255, 255, 255, 1)",
                accentColor: "rgba(255, 255, 255, 0.5)",
                fontFamily: "Roboto, sans-serif"
            },
            {
                name: "Night - low contrast", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(60, 60, 60, 1)",
                accentColor: "rgba(60, 60, 60, 0.5)",
                fontFamily: "Roboto, sans-serif"
            },
            {
                name: "Night - high contrast", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(255, 255, 0, 1)",
                accentColor: "rgba(255, 255, 0, 0.5)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "Sepia - dyslexic", 
                backgroundColor: "rgba(251, 240, 217, 1)",
                color: "rgba(95, 75, 50, 1)",
                accentColor: "rgba(95, 75, 50, 0.5)",
                fontFamily: "dyslexic, sans-serif"
            },
            {
                name: "Day - dyslexic", 
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(0, 0, 0, 1)",
                accentColor: "rgba(0, 0, 0, 0.5)",
                fontFamily: "dyslexic, sans-serif"
            },
            {
                name: "Night - dyslexic", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(255, 255, 255, 1)",
                accentColor: "rgba(255, 255, 255, 0.5)",
                fontFamily: "dyslexic, sans-serif"
            },
            {
                name: "Night - low contrast - dyslexic", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(60, 60, 60, 1)",
                accentColor: "rgba(60, 60, 60, 0.5)",
                fontFamily: "dyslexic, sans-serif"
            },
            {
                name: "Zany", 
                backgroundColor: "rgba(255, 0, 255, 1)",
                color: "rgba(0, 255, 0, 1)",
                accentColor: "rgba(255, 255, 0, 1)",
                fontFamily: "Comic Sans MS, Verdana"
            },
            {
                name: "Sepia - roboto", 
                backgroundColor: "rgba(251, 240, 217, 1)",
                color: "rgba(95, 75, 50, 1)",
                accentColor: "rgba(95, 75, 50, 0.5)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "Night - high contrast - dyslexic", 
                backgroundColor: "rgba(0, 0, 0, 1)",
                color: "rgba(255, 255, 0, 1)",
                accentColor: "rgba(255, 255, 0, 0.5)",
                fontFamily: "dyslexic, sans-serif"
            },
            {
                name: "220",
                backgroundColor: "rgba(255, 180, 0, 1)",
                color: "rgba(0, 45, 95, 1)",
                accentColor: "rgba(0, 45, 95, 0.5)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "057",
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(0, 43, 84, 1)",
                accentColor: "rgba(255, 50, 0, 1)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "074",
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(24, 164, 229, 1)",
                accentColor: "rgba(227, 114, 34, 1)",
                fontFamily: "Roboto-normal, sans-serif"
            },
            {
                name: "DHJ",
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(222, 37, 51, 1)",
                accentColor: "rgba(222, 37, 51, 1)",
                fontFamily: "sans-serif"
            },
            {
                name: "VVD",
                backgroundColor: "rgba(255, 255, 255, 1)",
                color: "rgba(7, 27, 115, 1)",
                accentColor: "rgba(253, 122, 0, 1)",
                fontFamily: "Roboto-normal, sans-serif"
            }


        ];
        
        if ( typeof pThemeNumber === 'string'){
            pThemeNumber = parseInt(pThemeNumber);
        }
        if ((  typeof pThemeNumber !== 'number')
            ||(isNaN (pThemeNumber))
            ||(pThemeNumber < 0)
            ||(pThemeNumber >= lThemes.length)){
            pThemeNumber = 1;
        }
        window.document.body.style.backgroundColor = lThemes[pThemeNumber].backgroundColor;
        window.document.body.style.color = lThemes[pThemeNumber].color;
        window.document.body.style.fontFamily = lThemes[pThemeNumber].fontFamily;
        window.__output.style.borderBottomColor = lThemes[pThemeNumber].accentColor;

        toast(lThemes[pThemeNumber].name);

        if (localStorageOK()){
            localStorage.setItem(LS_KEY_THEME, pThemeNumber);
        }

    }

    function localStorageOK(){
        return (typeof localStorage !== 'undefined');
    }

    /* event handling */
    function paste(pEvent){
        if (pEvent && pEvent.clipboardData) {
            window.__output.className = "";
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_BUFFER, pEvent.clipboardData.getData("text/plain"))
            }
            setDocumentTitle("clipboard");
            playString(pEvent.clipboardData.getData("text/plain"));
        }
        pEvent.preventDefault();
    }

    function drag(pEvent){
        pEvent.preventDefault();
    }
    function dragEnter(pEvent){
        pEvent.preventDefault();
    }
    function dragLeave(pEvent){
        pEvent.preventDefault();
         window.__output.className="breathing";
    }
    function dragStart(pEvent){
        pEvent.preventDefault();
    }
    function dragOver(pEvent){
        pEvent.preventDefault();
        window.__output.className = "openmouth";
    }
    function dragEnd(pEvent){
        pEvent.preventDefault();
        window.__output.className = "breathing";
    }
    function drop(pEvent){
        window.__output.className = "playing";
        if (pEvent.dataTransfer.files.length > 0){
            var lFile = pEvent.dataTransfer.files[0];
            if (lFile.type === "text/plain"){
                rReader.readAsText(lFile);
                setDocumentTitle(lFile.name);
            }
        } else { 
            function hasTextMime(pKindOfIterableObject){
                for (var i=0;i<pKindOfIterableObject.length;i++){
                    if ("text/plain" === pKindOfIterableObject[i]) {
                        return true;
                    }
                }
                return false;
            }

            if (hasTextMime(pEvent.dataTransfer.types)) {
                if (localStorageOK()) {
                    localStorage.setItem(LS_KEY_BUFFER, pEvent.dataTransfer.getData("text/plain"))
                }
                setDocumentTitle("drag/ drop");
                playString(pEvent.dataTransfer.getData("text/plain"));
            }
        }
        pEvent.preventDefault();
    }

    function click (pEvent) {
        if (pEvent.clientY > (window.innerHeight - 25)){
            var lSelectedPosition = pEvent.clientX/__droparea.scrollWidth;
            words.setPosition(Math.floor(lSelectedPosition * words.getLength()));
            updateNavigation(true);
        } else {
            if (pEvent.clientX > ((3/4)*window.innerWidth)){
                togglePlay();
            } else if (pEvent.clientX < ((1/4)*window.innerWidth)){
                words.gotoStartOfSentence();
                updateNavigation(false);
            } else {
                if (pEvent.clientY < ((1/4)*window.innerHeight)){
                    words.incSpeed(5);
                    updateSpeed(words.getSpeed());
                } else if (pEvent.clientY > ((3/4)*window.innerHeight)){
                    words.decSpeed(5);
                    updateSpeed(words.getSpeed());
                }
            }
        }
    }

    function keydown (pEvent) {
        // console.log(pEvent.keyCode);
        if (   HOME_KEY === pEvent.keyCode ) {
            words.setPosition(0);
            updateNavigation(true);
        }
        if (   C_KEY === pEvent.keyCode ) {
            playString("");
            if (localStorageOK()) {
                localStorage.removeItem(LS_KEY_BUFFER);
                localStorage.removeItem(LS_KEY_TITLE);
                localStorage.removeItem(LS_KEY_POSITION);
                localStorage.removeItem(LS_KEY_SPEED);
                localStorage.removeItem(LS_KEY_THEME);
            }
            words.setPosition(0);
            updateNavigation(true);
        }
        if (   END_KEY === pEvent.keyCode ) {
            words.setPosition(words.getLength());
            updateNavigation(true);
        }
        if (   DOT_KEY === pEvent.keyCode
            || COMMA_KEY === pEvent.keyCode
            || SLASH_KEY === pEvent.keyCode ) {
            toggleStatus();
        }
        if (   T_KEY === pEvent.keyCode ) {
            updateTimeToGo();
        }
        if(   SPACE_KEY === pEvent.keyCode
           || ENTER_KEY === pEvent.keyCode ) {
            togglePlay();
        }
        if (   LEFT_KEY === pEvent.keyCode
            || BACKSPACE_KEY === pEvent.keyCode
            || H_KEY === pEvent.keyCode
            || A_KEY === pEvent.keyCode ){
            words.decPosition(1);
            updateNavigation(true);
        }
        if (    PAGEDOWN_KEY === pEvent.keyCode
             || E_KEY === pEvent.keyCode) {
            words.gotoEndOfSentence();
            updateNavigation(true);
        }
        if (   RIGHT_KEY === pEvent.keyCode
            || L_KEY === pEvent.keyCode
            || D_KEY === pEvent.keyCode ) {
            words.incPosition(1);
            updateNavigation(true);
        }
        if (    PAGEUP_KEY === pEvent.keyCode
             || Q_KEY === pEvent.keyCode) {
            words.gotoStartOfSentence();
            updateNavigation(true);
        }
        if (    DOWN_KEY === pEvent.keyCode
             || J_KEY === pEvent.keyCode
             || S_KEY === pEvent.keyCode) {
            words.decSpeed(5);
            updateSpeed(words.getSpeed());
        }
        if (    UP_KEY === pEvent.keyCode
             || K_KEY == pEvent.keyCode
             || W_KEY == pEvent.keyCode ) {
            words.incSpeed(5);
            updateSpeed(words.getSpeed());
        }
        if ( B_KEY === pEvent.keyCode ) {
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_POSITION, words.getPosition()); 
            }
            toast("position saved");
        }
        if (ZERO_KEY  === pEvent.keyCode) { setTheme(0); }
        if (ONE_KEY   === pEvent.keyCode) { setTheme(1); }
        if (TWO_KEY   === pEvent.keyCode) { setTheme(2); }
        if (THREE_KEY === pEvent.keyCode) { setTheme(3); }
        if (FOUR_KEY  === pEvent.keyCode) { setTheme(4); }
        if (FIVE_KEY  === pEvent.keyCode) { setTheme(5); }
        if (SIX_KEY   === pEvent.keyCode) { setTheme(6); }
        if (SEVEN_KEY === pEvent.keyCode) { setTheme(7); }
        if (EIGHT_KEY === pEvent.keyCode) { setTheme(8); }
        if (NINE_KEY  === pEvent.keyCode) { setTheme(9); }
        if (   SECTION_KEY_FF === pEvent.keyCode 
            || SECTION_KEY    === pEvent.keyCode) {
            setTheme(10);
        }
        window.__droparea.value = "";
    }

    function wheel (pEvent){
        pEvent.preventDefault();
        if (pEvent.deltaY) {
            if (pEvent.deltaY > 0){
                words.incPosition(1);
            } else if(pEvent.deltaY < 0)  {
                words.decPosition(1);
            }
        } else if (   pEvent.deltaX && pEvent.deltaX !== 0
                   && pEvent.deltaY === 0){
            if (pEvent.deltaX > 0){
                words.decPosition(1); // not a typo
            } else if(pEvent.deltaX < 0)  {
                words.incPosition(1); // not a typo
            }
        }
        updateNavigation(true);
    }

    function loadend (pEvent){
        if (pEvent && pEvent.target && pEvent.target.result) {
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_BUFFER, pEvent.target.result);
            }
            playString(pEvent.target.result);
        }
    }

    rReader.addEventListener("loadend", loadend);

    window.__droparea.addEventListener("drag", drag, true);
    window.__droparea.addEventListener("dragenter", dragEnter, true);
    window.__droparea.addEventListener("dragleave", dragLeave, true);
    window.__droparea.addEventListener("dragstart", dragStart, true);
    window.__droparea.addEventListener("dragover", dragOver, true);
    window.__droparea.addEventListener("dragend", dragEnd, true);
    window.__droparea.addEventListener("paste", paste, true);
    window.__droparea.addEventListener("click", click, true);
    window.__droparea.addEventListener("drop", drop, true);
    window.document.body.addEventListener("keydown", keydown, true);
    window.document.body.addEventListener("wheel", wheel, true);


    if (localStorageOK()) {
        if (localStorage.getItem(LS_KEY_SPEED)){
            words.setSpeed(localStorage.getItem(LS_KEY_SPEED));
        }
        if (localStorage.getItem(LS_KEY_BUFFER)){
            words.init(localStorage.getItem(LS_KEY_BUFFER));
        }
        if (localStorage.getItem(LS_KEY_TITLE)){
            setDocumentTitle(localStorage.getItem(LS_KEY_TITLE));
        }
        if (localStorage.getItem(LS_KEY_POSITION)){
            words.setPosition(localStorage.getItem(LS_KEY_POSITION));
            displayWord(words.getCurrentWord());
        }
        if (localStorage.getItem(LS_KEY_THEME)){
            setTheme(localStorage.getItem(LS_KEY_THEME));
        }
    }


    /**
     * returns true if pString equals "1", "true", "y" or "yes
     */
    function isBooleanesqueTrue (pString){
        return (["1", "true", "y", "yes"].indexOf(pString)> -1);
    }

    if (rParams.speed) {
        words.setSpeed(rParams.speed);
    }
    if (rParams.theme) {
        setTheme(rParams.theme);
    }
    if (rParams.text) {
        words.init(decodeURIComponent(rParams.text));
        displayWord(words.getCurrentWord());
        updateTimeToGo();
        rDocumentTitle = "url";
    }
    if (rParams.pos) {
        words.setPosition(rParams.pos);
        displayWord(words.getCurrentWord());
    }
    if (rParams.loop && isBooleanesqueTrue(rParams.loop)) {
        rLoop = true;
        console.log("loopy");
    } else {
        rLoop = false;
    }
    if (rParams.play && isBooleanesqueTrue(rParams.play)) {
        window.setTimeout(play, INITIAL_DISPLAY_DELAY);
    }
}();
    </script>
</html>
