<!DOCTYPE html>
<html>
    <head>
    <!--
    todo
    - local storage for more than one book
    - gentle introduction for first time use (/ demo mode)
    - mobile interface tweaks
    - touch interface for loading text
    - change font size

    - Content retrieval methods
       - url
       - rss (?)
       - bookmarklet
    - Support other formats
       - html
       - epub
    -->
        <meta http-equiv="Default-Style" content="Sepia">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="WordyWordy takes text that's dropped on it and shows it. One word at a time. As fast as you want. Or as slow. Runs within your browser. Remembers where you left off between sessions. On the fly adjustable speed. Copious navigation options. GPLv3 open source licensed.">
        <meta name="keywords" content="rsvp, rapid serial visual presentation, wordywordy, one word at a time">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <link rel="icon" sizes="16x16 32x32 64x64" href="../favicon.ico">
        <link rel="icon" sizes="228x228" href="./favicon-228.png">
        <link rel="icon" sizes="195x195" href="./favicon-195.png">
        <link rel="icon" sizes="152x152" href="./favicon-152.png">
        <link rel="icon" sizes="144x144" href="./favicon-144.png">
        <link rel="icon" sizes="128x128" href="./favicon-128.png">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="./iosfavicon-152.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="./iosfavicon-144.png">
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="./iosfavicon-120.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="./iosfavicon-114.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="./iosfavicon-72.png">
        <link rel="apple-touch-icon-precomposed" href="./iosfavicon-57.png">
        <link rel="shortcut icon" href="./favicon.ico">


        <title>WordyWordy</title>
        <style>
            @font-face {
                font-family: 'controls';
                src:url('font/controls.eot?-i9on8r');
                src:url('font/controls.eot?#iefix-i9on8r') format('embedded-opentype'),
                    url('font/controls.woff?-i9on8r') format('woff'),
                    url('font/controls.ttf?-i9on8r') format('truetype'),
                    url('font/controls.svg?-i9on8r#controls') format('svg');
                font-weight: normal;
                font-style: normal;
            }
            [class^="icon-"], [class*=" icon-"] {
                font-family: 'controls';
                speak: none;
                font-style: normal;
                font-weight: normal;
                font-variant: normal;
                text-transform: none;
                line-height: 1;

                /* Better Font Rendering =========== */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            .icon-film:before { content: "\e913"; }
            .icon-video-camera:before { content: "\e914"; }
            .icon-file-text2:before { content: "\e926"; }
            .icon-copy:before { content: "\e92c"; }
            .icon-paste:before { content: "\e92d"; }
            .icon-folder:before { content: "\e92f"; }
            .icon-stopwatch:before { content: "\e952"; }
            .icon-zoom-in:before { content: "\e987"; }
            .icon-zoom-out:before { content: "\e988"; }
            .icon-question:before { content: "\ea09"; }
            .icon-plus:before { content: "\ea0a"; }
            .icon-minus:before { content: "\ea0b"; }
            .icon-info:before { content: "\ea0c"; }
            .icon-cancel-circle:before { content: "\ea0d"; }
            .icon-cross:before { content: "\ea0f"; }
            .icon-play2:before { content: "\ea15"; }
            .icon-pause:before { content: "\ea16"; }
            .icon-stop:before { content: "\ea17"; }
            .icon-previous:before { content: "\ea18"; }
            .icon-next:before { content: "\ea19"; }
            .icon-backward:before { content: "\ea1a"; }
            .icon-forward2:before { content: "\ea1b"; }
            .icon-play3:before { content: "\ea1c"; }
            .icon-pause2:before { content: "\ea1d"; }
            .icon-stop2:before { content: "\ea1e"; }
            .icon-backward2:before { content: "\ea1f"; }
            .icon-forward3:before { content: "\ea20"; }
            .icon-first:before { content: "\ea21"; }
            .icon-last:before { content: "\ea22"; }
            .icon-previous2:before { content: "\ea23"; }
            .icon-next2:before { content: "\ea24"; }
            .icon-loop2:before { content: "\ea2e"; }
            .icon-arrow-up-left:before { content: "\ea31"; }
            .icon-arrow-up:before { content: "\ea32"; }
            .icon-arrow-right:before { content: "\ea34"; }
            .icon-arrow-down-right:before { content: "\ea35"; }
            .icon-arrow-down:before { content: "\ea36"; }
            .icon-arrow-left:before { content: "\ea38"; }
            .icon-circle-up:before { content: "\ea41"; }
            .icon-circle-right:before { content: "\ea42"; }
            .icon-circle-down:before { content: "\ea43"; }
            .icon-circle-left:before { content: "\ea44"; }
            .icon-share:before { content: "\ea7d"; }
            .icon-embed:before { content: "\ea7f"; }
            .icon-terminal:before { content: "\ea81"; }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 100;
                font-style       : normal;
                src: url('font/Roboto-Thin.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 100;
                font-style       : italic;
                src: url('font/Roboto-ThinItalic.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 300;
                font-style       : normal;
                src: url('font/Roboto-Light.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 300;
                font-style       : italic;
                src: url('font/Roboto-LightItalic.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 400;
                font-style       : normal;
                src: url('font/Roboto-Regular.ttf');
            }
            @font-face {
                font-family      : "Roboto";
                font-weight      : 400;
                font-style       : italic;
                src: url('font/Roboto-Italic.ttf');
            }
            @font-face {
                font-family      : "dyslexic";
                font-weight      : normal;
                font-style       : normal;
                src: url('font/OpenDyslexicAlta-Regular.otf');
            }
            body, span, div, textarea {
                margin: 0;
                border: 0;
                padding: 0;
            }
            body {
                background-color: rgba(251, 240, 217, 1);
                color: rgba(95, 75, 50, 1);
                font-family: Roboto, sans-serif;
                font-weight: 300;
                font-size: 48pt;
            }
            div.outputwrap {
                width:100%;
                position: absolute;
                text-align: center;
                top: 40%;
                background-color: inherit;
            }
            @-webkit-keyframes openmouth {
                0% {}
                100% {border-radius:1em; border-width: 0.2em; }
            }
            @keyframes openmouth {
                0% {}
                100% {border-radius:1em; border-width: 0.2em; }
            }
            .openmouth {
                -webkit-animation-name: openmouth;
                -webkit-animation-duration: 1s;
                -webkit-animation-iteration-count:1;
                -webkit-animation-timing-function: linear;
                -webkit-animation-direction: alternate;
                -webkit-animation-fill-mode:forwards;
                animation-name: openmouth;
                animation-duration: 1s;
                animation-iteration-count:1;
                animation-timing-function: linear;
                animation-direction: alternate;
                animation-fill-mode:forwards;
            }
            .smile {
                -webkit-animation-name: openmouth;
                -webkit-animation-duration: 1.0s;
                -webkit-animation-iteration-count:2;
                -webkit-animation-timing-function: linear;
                -webkit-animation-direction: alternate;
                animation-name: openmouth;
                animation-duration: 1.0s;
                animation-iteration-count:2;
                animation-timing-function: linear;
                animation-direction: alternate;
            }
            @-webkit-keyframes reload {
                0% {}
                85% {
                    padding: 0 0 0.2em 25%;
                    border-radius: 0 0 0 1em;
                    -webkit-filter: blur(0px);
                }
                100% {
                    -webkit-filter: blur(0.2em);
                }
            }
            @keyframes reload {
                0% {}
                85% {
                    padding: 0 0 0.2em 25%;
                    border-radius: 0 0 0 1em;
                    -moz-filter: blur(0px);
                    filter: blur(0px);
                }
                100% {
                    -moz-filter: blur(0.2em);
                    filter: blur(0.2em);
                }
            }
            .reload {
                -webkit-animation-name: reload;
                -webkit-animation-duration: 950ms;
                -webkit-animation-iteration-count: 1;
                -webkit-animation-timing-function: linear;
                animation-name: reload;
                animation-duration: 950ms;
                animation-iteration-count: 1;
                animation-timing-function: linear;
            }
            @-webkit-keyframes breathe-border {
                0% { border-color: currentColor; }
                40% { border-color: rgba(128, 128, 128, 1); }
                50% { border-color: rgba(128, 128, 128, 1); }
                60% { border-color: rgba(128, 128, 128, 1); }
                100% { border-color: currentColor; }
            }
            @keyframes breathe-border {
                0% { border-color: currentColor; }
                40% { border-color: rgba(128, 128, 128, 1); }
                50% { border-color: rgba(128, 128, 128, 1); }
                60% { border-color: rgba(128, 128, 128, 1); }
                100% { border-color: currentColor; }
            }
            .breathing {
                /*
                 nice idea. Strangely, saps a lot of energy.

                -webkit-animation-name: breathe-border;
                -webkit-animation-duration: 6s;
                -webkit-animation-iteration-count: infinite;
                -webkit-animation-timing-function: ease-in-out;
                animation-name: breathe-border;
                animation-duration: 6s;
                animation-iteration-count: infinite;
                animation-timing-function: ease-in-out;
                */
            }
            .playing {
            }
            #__output {
                padding: 0 0.6em 0.2em 0.6em;
                border-bottom: 3px solid currentColor; /*accent*/
                background-color: inherit;
            }
            #__percentagewrap {
                position: fixed;
                bottom:0;
                left:0;
                height: 0.3em;
                width: 100%;
                z-index: 3;
            }
            #__percentage {
                background-color:currentColor; /*accent*/
                opacity: 0.5;
                text-align: left;
                height: 0.2em;
                width: 0;
                bottom: 0;
                position:absolute;
            }
            #__droparea {
                position: fixed;
                z-index: 1;
                background-color: transparent;
                color: transparent;
                width: 100%;
                height: 100%;
                resize: none;
                cursor: default;
            }
            .clickarea {
                position: fixed;
                z-index: 2;
                /*
                background-color: red;
                opacity: 0.6;
                */
            }
            #__leftarea {
                position: fixed;
                width: 20%;
                left: 0;
                height: 100%;
            }
            #__rightarea {
                position: fixed;
                width: 20%;
                right: 0;
                height: 100%;
            }
            #__uparea {
                position: fixed;
                width: 100%;
                top: 0.3em;
                height: 20%;
            }
            #__downarea {
                position: fixed;
                width: 100%;
                bottom: 0.3em;
                height: 20%;
            }
            #__status {
                width: 100%;
                position: absolute;
                text-align: center;
                display: none;
                font-size: 0.3em;
            }
            #__status div {
                color: inherit; /*accent*/
                opacity: 0.5;
            }
            #__status table {
                color: inherit;
                width: 100%;
                font-size: inherit;
            }
            #__status td {
                font-weight: 300;
                text-align: left;
                font-size: inherit;
            }
            #__status td:first-child{
                font-style: italic;
                padding-right: 1em;
                text-align: right;
            }
            #__toast {
                position: absolute;
                bottom: 20%;
                margin-top: 1.4em;
                width: 100%;
                height: 1.4em;
                background-color: transparent;
                padding-top: 0.4em;
                /* color: inherit;*/ /*accent*/
                opacity: 0.5;
                text-align: center;
                display: none;
            }

            @keyframes fadeaway {
                100% {opacity: 0}
            }
            @-webkit-keyframes fadeaway {
                0% {}
                100% {opacity: 0}
            }
            .fade-away {
                -webkit-animation-name: fadeaway;
                -webkit-animation-duration: 0.3s;
                -webkit-animation-timing-function: ease-in;
                -webkit-animation-fill-mode : forwards;
                animation-name: fadeaway;
                animation-duration: 0.3s;
                animation-timing-function: ease-in;
                animation-fill-mode : forwards;
            }
            #__controls {
              position: fixed;
              text-align: center;
              width: 99%;
              bottom: .5em;
              z-index: 481;
            }
            #__controls nav {
              color: white;
              background-color: black;
              font-family: controls;
              font-size: 60%;
              padding: 0.25em 0.25em 0.25em 0.25em;
              opacity: 0.6;
              box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.6); /* 0.23 */
              display: inline;
            }
            #__controls button {
              color: inherit;
              background-color: inherit;
              font-family: inherit;
              font-size: inherit;
              box-shadow: none;
              border: none;
            }
            #__controls nav:hover {
              opacity: 0.9;
            }
            @media only screen and (max-width: 480px), (max-height: 480px) {
                .hideonmobile {
                    display:none;
                }
                #__controls {
                    bottom: 0;
                }
                #__percentagewrap {
                    bottom: inherit;
                    top: 0;
                }
                #__percentage {
                    bottom: inherit;
                    top: 0;
                }
            }
        </style>
        <style title="Sepia">
            body{
                color: rgba(95, 75, 50, 1);
                background-color: rgba(251, 240, 217, 1);
                font: normal normal 100 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(95, 75, 50, 0.5);
            }
        </style>
        <style title="Day">
            body{
                color: rgba(0, 0, 0, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 100 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(0, 0, 0, 0.5);
            }
        </style>
        <style title="Night">
            body{
                color: rgba(255, 255, 255, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 100 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(255, 255, 255, 0.5);
            }
        </style>
        <style title="Low contrast">
            body{
                color: rgba(60, 60, 60, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 100 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(60, 60, 60, 0.5);
            }
        </style>
        <style title="High contrast">
            body{
                color: rgba(255, 255, 0, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 400 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(255, 255, 0, 0.5);
            }
        </style>
        <style title="Dyslexic - Sepia">
            body{
                color: rgba(95, 75, 50, 1);
                background-color: rgba(251, 240, 217, 1);
                font: normal normal 400 48pt dyslexic, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(95, 75, 50, 0.5);
            }
        </style>
        <style title="Dyslexic - Day">
            body{
                color: rgba(0, 0, 0, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 400 48pt dyslexic, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(0, 0, 0, 0.5);
            }
        </style>
        <style title="Dyslexic - Night">
            body{
                color: rgba(255, 255, 255, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 400 48pt dyslexic, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(255, 255, 255, 0.5);
            }
        </style>
        <style title="Dyslexic - Low contrast">
            body{
                color: rgba(60, 60, 60, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 400 48pt dyslexic, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(60, 60, 60, 0.5);
            }
        </style>
        <style title="Dyslexic - High contrast">
            body{
                color: rgba(255, 255, 0, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 400 48pt dyslexic, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(255, 255, 0, 0.5);
            }
        </style>
        <style title="Zany">
            body{
                color: rgba(0, 255, 0, 1);
                background-color: rgba(255, 0, 255, 1);
                font: normal normal 400 48pt Comic Sans MS, Verdana;
                text-shadow: 1px 1px 2px black, 0 0 1em black, 0 0 0.2em black;
            }
            #__output {
                border-bottom-color: rgba(255, 255, 0, 1);
            }
            #__toast {
                color: cyan;
                opacity: 1;
            }
            #__percentage {
                background-color: pink;
                opacity: 1;
            }
            #__status {
                color: white;
                text-shadow: 1px 1px 2px black, 0 0 1em black, 0 0 0.2em black;
            }
            #__status div {
                opacity: 1;
            }
            @-webkit-keyframes animate {
                50%{
                    -webkit-transform: scale(0.99);
                    transform: scale(0.99);
                }
            }
            @keyframes animate {
                50%{
                    transform: scale(0.99);
                }
            }
            div.outputwrap {
                -webkit-animation-name: animate;
                -webkit-animation-iteration-count: infinite;
                -webkit-animation-duration: 1.2s;
                -webkit-animation-timing-function: ease-in-out;
                animation-name: animate;
                animation-iteration-count: infinite;
                animation-duration: 1.2s;
                animation-timing-function: ease-in-out;
            }
        </style>
        <style title="Low contrast - fatter font">
            body{
                color: rgba(60, 60, 60, 1);
                background-color: rgba(0, 0, 0, 1);
                font: normal normal 400 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(60, 60, 60, 0.5);
            }
        </style>
        <style title="Sepia - fatter font">
            body{
                color: rgba(95, 75, 50, 1);
                background-color: rgba(251, 240, 217, 1);
                font: normal normal 400 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(95, 75, 50, 0.5);
            }
        </style>
        <style title="220">
            body{
                color: rgba(0, 45, 95, 1);
                background-color: rgba(255, 180, 0, 1);
                font: normal normal 300 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(0, 45, 95, 0.5);
            }
        </style>
        <style title="057">
            body{
                color: rgba(0, 43, 84, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 300 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(255, 50, 0, 1);
            }
        </style>
        <style title="074">
            body{
                color: rgba(24, 164, 229, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 100 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(227, 114, 34, 1);
            }
            #__percentage {
                opacity: 1;
            }
        </style>
        <style title="HV">
            body{
                color: rgba(130, 191, 58, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 400 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(2, 119, 195, 1);
                border-bottom-width: 4px;
            }
        </style>
        <style title="DHJ">
            body{
                color: rgba(222, 37, 51, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 400 48pt "Helvetica Neue",Arial,sans-serif;
            }
            #__output {
                border-bottom-color: rgba(222, 37, 51, 1);
            }
        </style>
        <style title="liberal">
            body{
                color: rgba(7, 27, 115, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 400 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(253, 122, 0, 1);
                border-bottom-width: 6px;
            }
            #__percentage {
                background-color: rgba(253, 122, 0, 1);
                opacity: 1;
            }
        </style>
        <style title="progressive">
            body{
                color: rgba(218, 23, 46, 1);
                background-color: rgba(255, 255, 255, 1);
                font: normal normal 300 48pt Roboto, sans-serif;
            }
            #__output {
                border-bottom-color: rgba(134, 188, 0, 1);
            }
        </style>
    </head>
    <body>
        <textarea id="__droparea" class="hideonmobile"></textarea>
        <div class="clickarea" id="__uparea"></div>
        <div class="clickarea" id="__downarea"></div>
        <div class="clickarea" id="__leftarea"></div>
        <div class="clickarea" id="__rightarea"></div>
        <div class="outputwrap">
            <span id="__output" class="breathing"></span>
        </div>
        <span id="__status">
            <div>
            <table>
                <tr>
                    <td>Document</td>
                    <td>
                        <span id="__documentTitle"></span>
                    </td>
                </tr>
                <tr>
                    <td>Selected speed</td>
                    <td>
                        <span id="__selectedSpeed"></span>
                        <span title="words per minute">wpm</span>
                    </td>
                </tr>
                <tr>
                    <td>Calculated speed</td>
                    <td>
                        <span id="__avgSpeed"></span>
                        <span title="words per minute">wpm</span>
                    </td>
                </tr>
                <tr>
                    <td>Position</td>
                    <td>
                        <span id="__position"></span> of
                        <span id="__wordsTotal"></span> words
                        (<span id="__positionInPercent"></span>%)
                    </td>
                </tr>
                <tr>
                    <td>Words displayed</td>
                    <td>
                        <span id="__wordsPlayed"></span>
                        @<span id="__actualSpeed"></span>
                        <span title="words per minute">wpm</span>
                    </td>
                </tr>
                <tr>
                    <td><span class="icon-stopwatch"></span> spent + left = total</td>
                    <td>
                        <span id="__timeElapsed"></span> +
                        <span id="__timeToGo"></span> =
                        <span id="__timeTotal"></span>
                    </td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.1.2</td>
                </tr>
            </table>
            </div>
        </span>
        <span id="__toast"></span>
        <div id="__percentagewrap">
            <div id="__percentage"></div>
        </div>
        <div id="__controls">
            <nav id="__nav">
                <button id="__btn_open" class="icon-folder" title="open a text file to read"/>
                <button id="__btn_home" class="icon-first" title="go to start of text"/>
                <button id="__btn_dec" class="icon-previous2" title="one word back"/>
                <button id="__btn_playpause" class="icon-play3" title="play/ pause"/>
                <button id="__btn_inc" class="icon-next2" title="one word forward"/>
                <button id="__btn_end" class="icon-last hideonmobile" title="go to end of text" />
                <button id="__btn_slowdown" class="icon-circle-down" title="slow down" style="display:none"/>
                <button id="__btn_speedup" class="icon-circle-up" title="speed up" style="display:none"/>
                <button id="__btn_info" class="icon-info" title="toggle stats display" style="display:none"/>
            </nav>
            <input id="__input_file" type="file" accept="text/plain" style="display:none" ></input>
        </div>
    </body>
    <script>
/* jshint browser:true */
/* jshint nonstandard:true */
var fmt = function (){
    "use strict";

    var MILLISECONDS_PER_SECOND = 1000; // milliseconds
    var SECONDS_PER_MINUTE      = 60; // seconds
    var MINUTES_PER_HOUR        = 60; // minutes
    var HOURS_PER_DAY           = 24; // hours

    function millisToTimeStruct (pMilliSeconds) {
        var lSeconds = pMilliSeconds/ MILLISECONDS_PER_SECOND;
        var lMinutes = Math.max(0, lSeconds/ SECONDS_PER_MINUTE);
        var lHours   = Math.max(0, lMinutes/ MINUTES_PER_HOUR);
        var lDays    = Math.max(0, lHours/ HOURS_PER_DAY);

        var lMilliSeconds = Math.max(0, pMilliSeconds - (Math.floor(lSeconds)*MILLISECONDS_PER_SECOND));
        lSeconds     = Math.max(0, lSeconds - (Math.floor(lMinutes) * SECONDS_PER_MINUTE));
        lMinutes     = Math.max(0, lMinutes - (Math.floor(lHours) * MINUTES_PER_HOUR));
        lHours       = Math.max(0, lHours - (Math.floor(lDays) * HOURS_PER_DAY));

        return {
            "days"         : Math.floor(lDays),
            "hours"        : Math.floor(lHours),
            "minutes"      : Math.floor(lMinutes),
            "seconds"      : Math.floor(lSeconds),
            "milliseconds" : lMilliSeconds
        };
    }

    function formatTimeBlob (pInt) {
        if (pInt < 10) {
            return "0" + pInt;
        }
        return pInt.toString();
    }

    return {
        formatTime : function (pMilliSeconds, pShowMillis) {
            var lTimeStruct = millisToTimeStruct(pMilliSeconds);
            if (!pShowMillis) { pShowMillis = false; }
            var lRetval =
                   (lTimeStruct.hours > 0 ? lTimeStruct.hours + ":" : "") +
                   formatTimeBlob (lTimeStruct.minutes) + ":" +
                   formatTimeBlob (lTimeStruct.seconds) +
                   (pShowMillis ? "." + lTimeStruct.milliseconds: "");
            return lRetval;
        },
        sanitizeNumber : function (pThing, pDefault){
            if (typeof pThing  === 'string') {
                pThing = parseInt(pThing);
            }
            if (typeof pThing !== 'number' || isNaN(pThing) ){
                pThing = pDefault;
            }
            return pThing;
        },
        /**
         * returns true if pString equals "1", "true", "y" or "yes
         */
        sanitizeBooleanesque : function (pString){
            return (["1", "true", "y", "yes"].indexOf(pString)> -1);
        }
    };
}();

var words = function () {
    "use strict";

    var MIN_SPEED     = 60; // words per minute
    var DEFAULT_SPEED = 300; /// words per minute
    var MAX_SPEED     = 600; // words per minute

    var MIN_DELAY               = 100;
    var LETTER_DELAY            = 30;
    var CJK_DELAY               = 250;
    var NUMBER_DELAY            = 50;
    var CAPITALS_DELAY          = 50;
    var QUOTE_DELAY             = 40;
    var BRACKET_DELAY           = 100;
    var SHORT_PUNCTUATION_DELAY = 180;
    var LONG_PUNCTUATION_DELAY  = 250;
    var SENTENCE_END_DELAY      = 400;
    var PARAGRAPH_END_DELAY     = 250;

    var MILLISECONDS_PER_MINUTE = 60000; //milliseconds
    var MAX_SKIP_AHEAD          = 42; // words

    /*
     * SPACES_RE includes all spaces as mentioned in
     * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp
     * under \s, except the non-breaking space character, which is misused
     * in the time algorithm.
     */
    var SPACES_RE = new RegExp("[ \f\n\r\t\v\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+");
    var SENTENCE_END_CHARS = "\.\?\!\u3002\uFF1F";
    var SENTENCE_END_RE = new RegExp("["+SENTENCE_END_CHARS+"]");

    /*
     * Picture scripts (e.g. Chinese, Korean) need a different treatment.
     * These unicode code pointranges come from
     * http://www.unicode.org/Public/UCD/latest/ucd/Scripts.txt
     *
     * Japanese Hiragana and Katakana have been skipped intentionally as
     * these are actually phonetic scripts
     *
     */
    var HAN_CHAR  = "\u2E80-\u2E99|\u2E9B-\u2EF3|\u2F00-\u2FD5|\u3005|\u3007|\u3021-\u3029|\u3038-\u303A|\u303B|\u3400-\u4DB5|\u4E00-\u9FCC|\uF900-\uFA6D|\uFA70-\uFAD9";
    var YI_CHAR   = "\uA000-\uA014|\uA015|\uA016-\uA48C|\uA490-\uA4C6";
    var HANGUL_CHAR = "\u1100-\u11FF|\u302E-\u302F|\u3131-\u318E|\u3200-\u321E|\u3260-\u327E|\uA960-\uA97C|\uAC00-\uD7A3|\uD7B0-\uD7C6|\uD7CB-\uD7FB|\uFFA0-\uFFBE|\uFFC2-\uFFC7|\uFFCA-\uFFCF|\uFFD2-\uFFD7|\uFFDA-\uFFDC";
    var CJK_CHAR  = HAN_CHAR + "|" + YI_CHAR + "|" + HANGUL_CHAR;
    var CJK_RE    = new RegExp("(["+ CJK_CHAR +"])", "g");

    var rAry            = [];
    var rLength         = 0; // words
    var rSelectedSpeed  = DEFAULT_SPEED; // words per minute
    var rPosition       = 0; // word
    var rMinDelay       = MIN_DELAY*speed2Base(rSelectedSpeed);
    var rLetterDelay    = LETTER_DELAY*speed2Base(rSelectedSpeed);
    var rRe2delay       = [];
    var rRe2delayLength = 0;

    function _init(pString, pPosition){
        rAry = pString
                    .replace(/[\-]{4,}/g, "---") //
                    .replace(/[_]{4,}/g, "___") //
                    .replace(/[=]{4,}/g, "===") //
                    .replace(/[+]{4,}/g, "+++") //
                    .replace(/[~]{4,}/g, "~~~") //
                    .replace(/\.\.\./g, "…") //
                    .replace(/([a-zA-Z])([\(\)\[\]\{\}\.\?\!:;\-,…\/|\u2010-\u2015]{1,2})([a-zA-Z])/g, "$1$2 $3") //
                    .replace(/&nbsp;/g, " ") //
                    .replace(/\u00A0/g, " ") //
                    .replace(/\r\n/g, "\n") //
                    .replace(/[\n]{2,}/g, "\u00A0 ") // so we can distinguish "paragraph" ends
                    .replace(CJK_RE, " $1") //
                    .split(SPACES_RE);

        rLength = rAry.length;
        _setPosition(fmt.sanitizeNumber(pPosition, 0));
    }

    function _incPosition(pAmount) {
        _setPosition(rPosition + pAmount);
    }

    function _decPosition(pAmount) {
        _setPosition(rPosition - pAmount);
    }

    function _setPosition(pPosition){
        rPosition = Math.min(rLength, Math.max(0, pPosition));
    }

    function _getPosition(){
        return rPosition;
    }

    function _getPercentage(){
        return rLength > 0 ? 100*(rPosition/rLength) : 0;
    }

    function _setSpeed(pSpeed) {

        pSpeed         = fmt.sanitizeNumber(pSpeed, DEFAULT_SPEED);

        rSelectedSpeed = Math.min(MAX_SPEED, Math.max(MIN_SPEED, pSpeed));
        var lBase      = speed2Base(pSpeed);
        rMinDelay      = MIN_DELAY*lBase;
        rLetterDelay   = LETTER_DELAY*lBase;

        rRe2delay = [
            {re: SENTENCE_END_RE,  delay: SENTENCE_END_DELAY*lBase},
            {re: /[;:…–\u00B7|\u2010-\u2015]/,
                                   delay: LONG_PUNCTUATION_DELAY*lBase},
            {re: /[-,\/\uFF0C]/,   delay: SHORT_PUNCTUATION_DELAY*lBase},
            {re: /[\(\)\[\]\{\}]/, delay: BRACKET_DELAY*lBase},
            {re: /["'‘’“”]/,       delay: QUOTE_DELAY*lBase},
            {re: /\u00A0/,         delay: PARAGRAPH_END_DELAY*lBase},
            {re: /[0-9=\+]/,       delay: NUMBER_DELAY*lBase},
            {re: /[A-Z]/,          delay: CAPITALS_DELAY*lBase},
            {re: CJK_RE,           delay: CJK_DELAY*lBase}
        ];
        rRe2delayLength = rRe2delay.length;
    }

    function _getSpeed(){
        return rSelectedSpeed;
    }

    function _incSpeed(pAmount){
        _setSpeed(rSelectedSpeed + pAmount);
    }

    function _decSpeed(pAmount){
        _setSpeed(rSelectedSpeed - pAmount);
    }

    function _gotoStartOfSentence() {
        var lFound = false;
        if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
            rPosition--;
        }
        var lLimit = Math.max(rPosition - MAX_SKIP_AHEAD, 0);
        for (rPosition; (!lFound && (rPosition > lLimit)); rPosition--){
            if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
                lFound = true;
                rPosition += 2;
            }
        }
    }

    function _gotoEndOfSentence() {
        var lFound = false;
        var lLimit = Math.min(rPosition + MAX_SKIP_AHEAD, rLength);
        for (rPosition; (!lFound && (rPosition < lLimit)); rPosition++){
            if (rAry[rPosition] && rAry[rPosition].match(SENTENCE_END_RE)){
                lFound = true;
                rPosition -= 1;
            }
        }
    }

    function _getLength(){
        return rLength;
    }

    function _getCurrentWord(){
        return rAry[rPosition];
    }

    function regexp2duration(pChar){
        for (var i = 0; i < rRe2delayLength; i++){
            if (rRe2delay[i].re.test(pChar)){
                return rRe2delay[i].delay;
            }
        }
        return rLetterDelay;
    }

    /*
     * return the average speed in wpm for the current string
     */
    function _getAverageSpeed(){
        var lTotalDisplayTime = 0;
        for (var i = 0; i < rLength; i++){
            lTotalDisplayTime += _determineDisplayTime(rAry[i]);
        }
        return rLength/(lTotalDisplayTime/MILLISECONDS_PER_MINUTE);
    }

    function speed2Base (pSpeed) {
        return (MILLISECONDS_PER_MINUTE/pSpeed)/300;// 300 = min delay + (6 2/3)xletter delay. Works ok for english.
    }

    function _getDisplayTime() {
        return _determineDisplayTime(rAry[rPosition]);
    }

    function _determineDisplayTime(pWord){
        var lRetval = 0;
        if (pWord){
            lRetval = rMinDelay;
            for (var i = 0, lLength = pWord.length; i < lLength; i++){
                lRetval += regexp2duration(pWord[i]);
            }
        }
        return lRetval;
    }

    function _getEstimatedTimeToGo(){
        return MILLISECONDS_PER_MINUTE*(rLength - rPosition)/rSelectedSpeed;
    }

    return {
        init: _init,
        getSpeed: _getSpeed,
        setSpeed: _setSpeed,
        incSpeed: _incSpeed,
        decSpeed: _decSpeed,
        getCurrentWord: _getCurrentWord,
        getDisplayTime: _getDisplayTime,
        getLength: _getLength,
        getPercentage: _getPercentage,
        getEstimatedTimeToGo: _getEstimatedTimeToGo,
        getAverageSpeed: _getAverageSpeed,
        getPosition: _getPosition,
        setPosition: _setPosition,
        incPosition: _incPosition,
        decPosition: _decPosition,
        gotoEndOfSentence: _gotoEndOfSentence,
        gotoStartOfSentence: _gotoStartOfSentence
    };
}();

var paramslikker = function(){
    return {
        getParams: function (pSearchString) {
            var lRetval = {};
            if (pSearchString) {
                var lKeyValAry;
                //  search string always starts with a "?" - skip this
                pSearchString.slice(1).split("&").forEach(function(pKeyVal){
                    lKeyValAry = pKeyVal.split("=");
                    if (2 === lKeyValAry.length) {
                        lRetval[lKeyValAry[0]] = unescape(lKeyValAry[1]);
                    }
                });
            }
            return lRetval;
        }
    };
}();

var stopwatch = function (){
    "use strict";

    function Stopwatch () {
        this.reset = function () {
            this.state = "paused"; // running, paused
            this.startTime = Date.now();
            this.pauseStartTime = this.startTime;
            this.cumulativePauses = 0;
        };

        // constructor hack
        this.reset();
    }

    Stopwatch.prototype.start = function () {
        this.state             = "running";
        this.startTime         = Date.now();
        this.pauseStartTime    = this.startTime;
        this.cumulativePauses  = 0;
    };

    Stopwatch.prototype.resume = function () {
        this.state             = "running";
        var lPause             = (Date.now() - this.pauseStartTime);
        this.cumulativePauses += lPause;
    };

    Stopwatch.prototype.pause = function () {
        if (this.state !== "paused"){
            this.state             = "paused";
            this.pauseStartTime    = Date.now();
        }
    };

    Stopwatch.prototype.getTimeElapsed = function () {
        if (this.state === "running"){
            return Date.now() - this.startTime - this.cumulativePauses;
        } else {
            return this.pauseStartTime - this.startTime - this.cumulativePauses;
        }
    };

    return {Stopwatch: Stopwatch};
}();

var ctrl = function () {
    "use strict";

    var rPlaying     = false;
    var rWordsPlayed = 0;

    var rWordTimer;
    var rToastTimer;
    var rControlsTimer;
    var rHoveringOverControls = false;
    var rShowStatus    = false;
    var rLoop          = false;
    var rDocumentTitle = "";
    var rAppName       = "WordyWordy";

    var SPACE_KEY    = 32;
    var ENTER_KEY    = 13;
    var LEFT_KEY     = 37;
    var UP_KEY       = 38;
    var RIGHT_KEY    = 39;
    var DOWN_KEY     = 40;
    var SECTION_KEY_FF = 0;
    var SECTION_KEY  = 192; // on FF this is the ` (backquote)
                           // in safari both the § and ` key listen to 192
    var A_KEY        = 65;
    var B_KEY        = 66;
    var C_KEY        = 67;
    var D_KEY        = 68;
    var E_KEY        = 69;
    var O_KEY        = 79;
    var Q_KEY        = 81;
    var S_KEY        = 83;
    var T_KEY        = 84;
    var V_KEY        = 86;
    var W_KEY        = 87;
    var PAGEUP_KEY   = 33;
    var PAGEDOWN_KEY = 34;
    var HOME_KEY     = 36;
    var END_KEY      = 35;
    // var ESC_KEY = 27;
    var COMMA_KEY    = 188;
    var DOT_KEY      = 190;
    var SLASH_KEY    = 191;
    var ZERO_KEY     = 48;
    var ONE_KEY      = 49;
    var TWO_KEY      = 50;
    var THREE_KEY    = 51;
    var FOUR_KEY     = 52;
    var FIVE_KEY     = 53;
    var SIX_KEY      = 54;
    var SEVEN_KEY    = 55;
    var EIGHT_KEY    = 56;
    var NINE_KEY     = 57;

    var CH_PLAY           = '\u25B7'; // or \u23F5 which not available in std font
    var ICON_PLAY_CLASS   = "icon-play3";
    var ICON_PAUSE_CLASS  = "icon-pause2";

    var MILLISECONDS_PER_MINUTE = 60000; // milliseconds
    var INITIAL_DISPLAY_DELAY   = 1000;  // milliseconds
    var TOAST_FADE_TIME         = 2200;  // milliseconds

    /* localStorage keys */
    var LS_KEY_BUFFER    = 'buffer';
    var LS_KEY_TITLE     = 'title';
    var LS_KEY_POSITION  = 'position';
    var LS_KEY_SPEED     = 'speed';
    var LS_KEY_THEME     = 'theme';

    var rStopwatch = new stopwatch.Stopwatch();
    var rReader    = new FileReader();
    var rParams    = paramslikker.getParams(window.location.search);


    function playString(pString) {
        rWordsPlayed = 0;
        words.init(pString, 0);
        window.__avgSpeed.textContent = words.getAverageSpeed().toFixed(1);
        updateTimeToGo();
        rStopwatch.start();
        play();
    }

    function outputNextWord(){
        if (rWordTimer){
            window.clearTimeout(rWordTimer);
        }
        if (rLoop === true) {
            window.__output.className = "playing";
        }

        if (rPlaying){
            if (words.getPosition() < words.getLength()){
                rWordTimer = window.setTimeout(outputNextWord, words.getDisplayTime());
                displayWord(words.getCurrentWord(), true);
                words.incPosition(1);
            } else if (rLoop === true) {
                words.setPosition(0);
                window.__output.className = "reload";
                rWordTimer = window.setTimeout(outputNextWord, 1000);
            } else {
                window.__output.textContent = "";
                window.__output.className   = "smile";
                pause();
            }
        }
    }

    function displayWord(pWord, pAddsToPlayedCount){
        if (undefined !== pWord) {
            window.__output.innerHTML = pWord;
            window.__percentage.setAttribute("style",
                            "width: " + words.getPercentage() + "%;");
            if (rShowStatus){
                updateStatus();
            }
            if (pAddsToPlayedCount) {
                rWordsPlayed++;
            }
        }
    }

    function updateStatus() {
        var lTimeElapsed = rStopwatch.getTimeElapsed();
        var lMinutesRead = (lTimeElapsed)/MILLISECONDS_PER_MINUTE;

        var lActualSpeed = lMinutesRead > 0 ? rWordsPlayed/ lMinutesRead : 0;
        var lTimeToGo    = words.getEstimatedTimeToGo();
        var lTimeTotal   = lTimeElapsed + lTimeToGo;

        window.__documentTitle.textContent = rDocumentTitle;
        window.__selectedSpeed.textContent = words.getSpeed();
        window.__actualSpeed.textContent   = lActualSpeed.toFixed(0);
        window.__position.textContent      =  words.getPosition();
        window.__positionInPercent.textContent = words.getPercentage().toFixed(1);
        window.__wordsPlayed.textContent   =  rWordsPlayed;
        window.__wordsTotal.textContent    = words.getLength();

        window.__timeElapsed.textContent   = fmt.formatTime(lTimeElapsed);
        window.__timeToGo.textContent      = fmt.formatTime(lTimeToGo);
        window.__timeTotal.textContent     = fmt.formatTime(lTimeTotal);
    }

    function toggleStatus(){
        rShowStatus = !rShowStatus;
        if (rShowStatus){
            window.__status.style.display = "inline";
            updateStatus();
        } else {
            window.__status.style.display = "none";
        }
    }

    function play() {
        rStopwatch.resume();
        rPlaying = true;
        window.__output.className = "playing";
        window.__btn_playpause.className = ICON_PAUSE_CLASS;
        document.title = CH_PLAY + " " + rDocumentTitle + " - " + rAppName;
        outputNextWord();
    }

    function pause() {
        rStopwatch.pause();
        rPlaying = false;
        // __output.className = "breathing";
        document.title = rDocumentTitle + " - " + rAppName;
        window.__btn_playpause.className = ICON_PLAY_CLASS;
        if (localStorageOK()) {
            localStorage.setItem("position", words.getPosition());
        }
    }

    function toastControls(){
        if (rControlsTimer){
            window.clearTimeout(rControlsTimer);
        }
        window.__controls.className = "";
        rControlsTimer = window.setTimeout(function(){
                    window.__controls.className = "fade-away";
                }, TOAST_FADE_TIME);
    }

    function toast(pString){
        if (rToastTimer){
            window.clearTimeout(rToastTimer);
        }
        window.__toast.style.display = "block";
        window.__toast.className = "";
        window.__toast.innerHTML = pString;
        rToastTimer = window.setTimeout(function(){
                    window.__toast.className = "fade-away";
                },TOAST_FADE_TIME);
    }

    function setDocumentTitle(pString) {
        rDocumentTitle = pString;

        if (localStorageOK()){
            localStorage.setItem(LS_KEY_TITLE, pString);
        }
    }

    function updateNavigation (pPause) {
        if (pPause) {
            pause();
        }
        displayWord(words.getCurrentWord(), false);
        toast(words.getPercentage().toFixed(1) + "%");
    }

    function updateSpeed (pSpeed) {
        updateStatus();
        toast(pSpeed + " wpm");
        if (localStorageOK()) {
            localStorage.setItem(LS_KEY_SPEED, pSpeed);
        }
    }

    function updateTimeToGo() {
        toast("<span class='icon-stopwatch'></span>" + " -" + fmt.formatTime(words.getEstimatedTimeToGo()));
    }

    function setTheme(pThemeNumber){

        /*
         * The perfectly sensible way to do this is to
         * use the document.styleSheets collection and switch
         * the disabled property to false for the selected
         * theme, and switch it off for the others.
         *
         * WebKut, however, only sees the first stylesheet
         * with a title. Hence this even-more-ugly-than-usual
         * piece of code...
         */

        var lStyleSheets = document.querySelectorAll("style");
        var lStyleMetaTag = document.querySelectorAll("meta[http-equiv=Default-Style]")[0];
        var lStyleSheetsLength = lStyleSheets.length;

        if ((lStyleSheetsLength > 1) && lStyleMetaTag) {
            pThemeNumber = Math.min( lStyleSheetsLength - 1,
                                     Math.max(1, fmt.sanitizeNumber(pThemeNumber, 1))
                                   );

            /*
             * Dynamically setting the meta tag then doesn't work in
             * Gecko, hence some funky feature detection
             * (which only works when there are no external stylesheets
             * - which is good enough (tm) for now) and the straighforward
             * for loop
             */
            if (document.styleSheets.length === lStyleSheetsLength) {
                for (var i = 1; i < lStyleSheetsLength; i++){
                    if (i === pThemeNumber) {
                        document.styleSheets[i].disabled = false;
                    } else {
                        document.styleSheets[i].disabled = true;
                    }
                }
            } else {
                lStyleMetaTag.content = lStyleSheets[pThemeNumber].title;
            }

            toast(lStyleSheets[pThemeNumber].title);
            if (localStorageOK()){
                localStorage.setItem(LS_KEY_THEME, pThemeNumber);
            }
        }
    }

    function localStorageOK(){
        return (typeof localStorage !== 'undefined');
    }

    function openFile(){
        updateNavigation(true);
        window.__input_file.click();
    }
    function setPos(pPosition){
        words.setPosition(pPosition);
        updateNavigation(true);
    }
    function home(){
        setPos(0);
    }
    function dec(){
        words.decPosition(1);
        updateNavigation(true);
    }
    function playpause(){
        rPlaying = !rPlaying;
        if(rPlaying) {
            play();
        } else {
            pause();
        }
    }
    function inc(){
        words.incPosition(1);
        updateNavigation(true);
    }
    function end(){
        setPos(words.getLength());
    }

    function speedUp(){
        words.incSpeed(5);
        updateSpeed(words.getSpeed());
    }
    function slowDown(){
        words.decSpeed(5);
        updateSpeed(words.getSpeed());
    }

    /* event handling */
    function paste(pEvent){
        if (pEvent && pEvent.clipboardData) {
            window.__output.className = "";
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_BUFFER, pEvent.clipboardData.getData("text/plain"));
            }
            setDocumentTitle("clipboard");
            playString(pEvent.clipboardData.getData("text/plain"));
        }
        pEvent.preventDefault();
    }

    function drag(pEvent){
        pEvent.preventDefault();
    }
    function dragEnter(pEvent){
        pEvent.preventDefault();
    }
    function dragLeave(pEvent){
        pEvent.preventDefault();
         window.__output.className="breathing";
    }
    function dragStart(pEvent){
        pEvent.preventDefault();
    }
    function dragOver(pEvent){
        pEvent.preventDefault();
        window.__output.className = "openmouth";
    }
    function dragEnd(pEvent){
        pEvent.preventDefault();
        window.__output.className = "breathing";
    }
    function hasTextMime(pKindOfIterableObject){
        for (var i=0;i<pKindOfIterableObject.length;i++){
            if ("text/plain" === pKindOfIterableObject[i]) {
                return true;
            }
        }
        return false;
    }
    function drop(pEvent){
        window.__output.className = "playing";
        if (pEvent.dataTransfer.files.length > 0){
            var lFile = pEvent.dataTransfer.files[0];
            if (lFile.type === "text/plain"){
                rReader.readAsText(lFile);
                setDocumentTitle(lFile.name);
            }
        } else {
            if (hasTextMime(pEvent.dataTransfer.types)) {
                if (localStorageOK()) {
                    localStorage.setItem(LS_KEY_BUFFER, pEvent.dataTransfer.getData("text/plain"));
                }
                setDocumentTitle("drag/ drop");
                playString(pEvent.dataTransfer.getData("text/plain"));
            }
        }
        pEvent.preventDefault();
    }

    function percentageClick(pEvent) {
        var lSelectedPosition = pEvent.clientX/window.__percentagewrap.scrollWidth;
        setPos(Math.floor(lSelectedPosition * words.getLength()));
    }

    function keydown (pEvent) {
        // console.log(pEvent.keyCode);
        if (   HOME_KEY === pEvent.keyCode ) {
            home();
        }
        if (   C_KEY === pEvent.keyCode ) {
            playString("");
            if (localStorageOK()) {
                localStorage.removeItem(LS_KEY_BUFFER);
                localStorage.removeItem(LS_KEY_TITLE);
                localStorage.removeItem(LS_KEY_POSITION);
                localStorage.removeItem(LS_KEY_SPEED);
                localStorage.removeItem(LS_KEY_THEME);
            }
            home();
            toast("Forgot everything");
        }
        if (   END_KEY === pEvent.keyCode ) {
            end();
        }
        if ( DOT_KEY === pEvent.keyCode ||
             COMMA_KEY === pEvent.keyCode ||
             SLASH_KEY === pEvent.keyCode ) {
            toggleStatus();
        }
        if ( T_KEY === pEvent.keyCode ) {
            updateTimeToGo();
        }
        if( SPACE_KEY === pEvent.keyCode ||
            ENTER_KEY === pEvent.keyCode ) {
            playpause();
        }
        if ( LEFT_KEY === pEvent.keyCode ||
             A_KEY === pEvent.keyCode ){
            dec();
        }
        if (  PAGEDOWN_KEY === pEvent.keyCode ||
              E_KEY === pEvent.keyCode) {
            words.gotoEndOfSentence();
            updateNavigation(true);
        }
        if ( RIGHT_KEY === pEvent.keyCode ||
             D_KEY === pEvent.keyCode ) {
            inc();
        }
        if ( PAGEUP_KEY === pEvent.keyCode ||
             Q_KEY === pEvent.keyCode) {
            words.gotoStartOfSentence();
            updateNavigation(true);
        }
        if ( DOWN_KEY === pEvent.keyCode ||
             S_KEY === pEvent.keyCode) {
            slowDown();
        }
        if ( UP_KEY === pEvent.keyCode ||
             W_KEY == pEvent.keyCode ) {
            speedUp();
        }
        if ( O_KEY === pEvent.keyCode ) {
            openFile();
        }
        if ( B_KEY === pEvent.keyCode ) {
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_POSITION, words.getPosition());
            }
            toast("position saved");
        }
        if ( V_KEY === pEvent.keyCode ) {
            toast(rAppName + " 0.1.2");
        }
        if (ONE_KEY   === pEvent.keyCode) { setTheme(1); }
        if (TWO_KEY   === pEvent.keyCode) { setTheme(2); }
        if (THREE_KEY === pEvent.keyCode) { setTheme(3); }
        if (FOUR_KEY  === pEvent.keyCode) { setTheme(4); }
        if (FIVE_KEY  === pEvent.keyCode) { setTheme(5); }
        if (SIX_KEY   === pEvent.keyCode) { setTheme(6); }
        if (SEVEN_KEY === pEvent.keyCode) { setTheme(7); }
        if (EIGHT_KEY === pEvent.keyCode) { setTheme(8); }
        if (NINE_KEY  === pEvent.keyCode) { setTheme(9); }
        if (ZERO_KEY  === pEvent.keyCode) { setTheme(10); }
        if ( SECTION_KEY_FF === pEvent.keyCode ||
             SECTION_KEY    === pEvent.keyCode) {
            setTheme(11);
        }
        window.__droparea.value = "";
    }

    function wheel (pEvent){
        pEvent.preventDefault();
        if (pEvent.deltaY) {
            if (pEvent.deltaY > 0){
                inc();
            } else if(pEvent.deltaY < 0)  {
                dec();
            }
        } else if ( pEvent.deltaX && pEvent.deltaX !== 0 &&
                    pEvent.deltaY === 0){
            if (pEvent.deltaX > 0){
                dec(); // not a typo
            } else if(pEvent.deltaX < 0)  {
                inc(); // not a typo
            }
        }
        updateNavigation(true);
    }

    function loadend (pEvent){
        if (pEvent && pEvent.target && pEvent.target.result) {
            if (localStorageOK()) {
                localStorage.setItem(LS_KEY_BUFFER, pEvent.target.result);
            }
            playString(pEvent.target.result);
        }
    }

    rReader.addEventListener("loadend", loadend);

    function oink (pEvent){
        if (pEvent.target.files.length > 0){
            var lFile = pEvent.target.files[0];
            if (lFile.type === "text/plain"){
                rReader.readAsText(lFile);
                setDocumentTitle(lFile.name);
            }
        }
    }

    function mousemove(){
        if (!rHoveringOverControls) {
            toastControls();
        }
    }

    function controlsMouseover(){
        if (rControlsTimer) {
            window.clearTimeout(rControlsTimer);
        }
        rHoveringOverControls = true;
        window.__controls.className = "";
    }

    function controlsMouseout(){
        rHoveringOverControls = false;
    }

    window.__droparea.addEventListener("drag", drag, true);
    window.__droparea.addEventListener("dragenter", dragEnter, true);
    window.__droparea.addEventListener("dragleave", dragLeave, true);
    window.__droparea.addEventListener("dragstart", dragStart, true);
    window.__droparea.addEventListener("dragover", dragOver, true);
    window.__droparea.addEventListener("dragend", dragEnd, true);
    window.__droparea.addEventListener("paste", paste, true);
    window.__droparea.addEventListener("drop", drop, true);
    window.__percentagewrap.addEventListener("click", percentageClick, true);
    window.__uparea.addEventListener("click", speedUp, true);
    window.__downarea.addEventListener("click", slowDown, true);
    window.__leftarea.addEventListener("click", dec, true);
    window.__rightarea.addEventListener("click", playpause, true);
    window.__input_file.addEventListener("change", oink, true);
    window.__btn_open.addEventListener("click", openFile, true);
    window.__btn_home.addEventListener("click", home, true);
    window.__btn_dec.addEventListener("click", dec, true);
    window.__btn_playpause.addEventListener("click", playpause, false);
    window.__btn_inc.addEventListener("click", inc, true);
    window.__btn_end.addEventListener("click", end, true);
    window.__btn_slowdown.addEventListener("click", slowDown, true);
    window.__btn_speedup.addEventListener("click", speedUp, true);
    window.__btn_info.addEventListener("click", toggleStatus, true);
    window.document.body.addEventListener("keydown", keydown, true);
    window.document.body.addEventListener("wheel", wheel, true);
    window.document.body.addEventListener("mousemove", mousemove, true);
    window.__controls.addEventListener("mouseover", controlsMouseover, true);
    window.__controls.addEventListener("mouseout", controlsMouseout, true);


    if (localStorageOK()) {
        if (localStorage.getItem(LS_KEY_SPEED)){
            words.setSpeed(localStorage.getItem(LS_KEY_SPEED));
        }
        if (localStorage.getItem(LS_KEY_BUFFER)){
            words.init(localStorage.getItem(LS_KEY_BUFFER));
        }
        if (localStorage.getItem(LS_KEY_TITLE)){
            setDocumentTitle(localStorage.getItem(LS_KEY_TITLE));
        }
        if (localStorage.getItem(LS_KEY_POSITION)){
            words.setPosition(localStorage.getItem(LS_KEY_POSITION));
            displayWord(words.getCurrentWord());
        }
        if (localStorage.getItem(LS_KEY_THEME)){
            setTheme(localStorage.getItem(LS_KEY_THEME));
        }
    }

    if (rParams.speed) {
        words.setSpeed(rParams.speed);
    }
    if (rParams.theme) {
        setTheme(rParams.theme);
    }
    if (rParams.text) {
        words.init(decodeURIComponent(rParams.text));
        displayWord(words.getCurrentWord());
        updateTimeToGo();
        rDocumentTitle = "url";
    }
    if (rParams.pos) {
        words.setPosition(rParams.pos);
        displayWord(words.getCurrentWord());
    }
    if (rParams.loop && fmt.sanitizeBooleanesque(rParams.loop)) {
        rLoop = true;
    } else {
        rLoop = false;
    }
    if (rParams.play && fmt.sanitizeBooleanesque(rParams.play)) {
        window.setTimeout(play, INITIAL_DISPLAY_DELAY);
    }
    var rCannedTexts = {
      "choo-choo": "Don't ask me silly questions, I won't play silly games. I'm just a simple choo-choo train, and I'll always be the same. I only want to race along, beneath the bright blue sky. And be a happy choo-choo train until the day I die.",
      "1984":"DOWN WITH BIG BROTHER!\nDOWN WITH BIG BROTHER!\nDOWN WITH BIG BROTHER!",
      "intro": "Thank you for your interest in WordyWordy! As you might have surmised, WordyWordy displays text. One word at a time. At the speed you want it to.\n\nThe speed at which you are reading this is 150 words per minute. If this is not right for you, you can change it with the {up} and {down} keys on your keyboard. If you don't have a keyboard, click or tap the middle top of the screen to speed up and the middle bottom of the screen to slow down.\n\nGo on.\n\nAdjust it while you are at it. Faster={up}. Slower={down}.\n\nHere is some text to test if the reading speed is comfortable, while you are twiddling the {up} and {down} keys. (What? You weren't? go on! {up} , {up} , {up}!). As a reference: when you are an average adult person you will probably read books and papers at a rate of about 240 words per minute. When that seems too fast for you: RELAX. You're <em>NOT</em> <em>average</em>. Being NOT AVERAGE is TOTALY OK. Even better: WordyWordy was created with you in mind.\n\nOn the other hand, if faster seems to do it for you: knock yourself out! There's people who claim they can read at 400 words per minute. There's even people who claim they can read faster than that, although I don't believe them :-).\n\nNow that your reading speed is adjusted to your comfort level, you might want to know some things. I'll tick them off in order of likelihood:\n\n1. -->WHY?<--\n\nWhy would people read text in this way? I have identified several of them:\n1. Low vision.\n2. Dyslexia.\n3. Hands free reading.\n4. Speed reading.\n\n1/4  Low vision\n\nYou might have noticed the letters are BIG. And you don't have to move your eyes a lot. This can be practical for people with low vision. There is even a special HIGH CONTRAST theme (accessible under the {5} (five) key of your keyboard).\n\n\n2/4 Dyslexia\n\nI have read claims (but not proof) that people with dyslexia can absorb text better this way. I have no idea whether or not that is true. Just in case it is, WordyWordy has some themes that sport dyslexia friendly fonts. A dyslexia friendly front is bottom heavy. Letters in a dyslexia friendly font are as distinct from each other as possible.\n\nIf you want to see the dyslexia font in action, you can hit the {6} (six) key on your keyboard. You can hit {1} to go back to the regular font.\n\n\n3/4 Hands free reading\n\nWell, this is self evident. You didn't have to scroll one bit while reading this. You can step on your home trainer and have WordyWordy read a book to you. Or do push-ups.\n\n\n4/4 Speed reading\n\nIt is also claimed, although I haven't seen actual research supporting this, you can read faster like this. Exactly because your eyes don't have to move to the start of the next line again.\n\nThe second thing you might want to know...\n\n2. How do I navigate through the text?\n\nIf you want to pause text display, hit your {space} bar, or click/ tap on the {>} button in the controls island.\n\nWait. Controls island? What are you talking about?\n\nThe controls island is the thing that keeps popping in and out of view while you move your mouse.\n\nHitting the {space} bar or the {>} one of these again will make WordyWordy resume reading from the current position.\n\nThere's a lot of ways to move back and forth through the text. You can use the {left} and {right} keys on your keyboard. You can use the {<<} and {>>} buttons on the controls island. You can use the {scroll} wheel on your mouse.\n\nIf you are an advanced reader, you might be happy to know WordyWordy supports like navigating sentences or paragraphs at a time. If you're interested, take a peek at the (short but concise) documentation on github.\n\nThe third thing you might want to know...\n\n3. How do I get this to read MY text?\n\nCurrently there are three ways to do this: copy/ paste, drag/ drop, open file. There is a fourth one but that is an itty bitty technical (URL). You can look it up on the github home page of this project if you want to.\n\nGetting text into WordyWordy 1/3: copy/ paste\nCopy some text and paste it on the horizontal line in the middle of the screen (or thereabouts). WordyWordy will start reading it to you at its current speed (which you can adjust, remember? {up} {down}).\n\nGetting text into WordyWordy 2/3: drag/ drop\nSelect a file on you desktop computer and drag it over to the horizontal line in the middle of the screen and drop it there. You'll know you do it right when WordyWordy smiles at you.\n\nGetting text into WordyWordy 3/3: open file\nYou might have noticed the {FOLDER} icon on the bottom of this screen (if it's not in view, move your mouse a bit or tap the middle of the screen). When you click it, WordyWordy will open your browser's upload dialog. With this, select a text file you want it to read. When done, WordyWordy will read it to you. We have tested this with pretty big text files (900 kilobytes).\n\nJust remember that, at this time, WordyWordy only knows how to handle plain text files, so it doesn't know what to do with word documents or ebook formats like ePub. I might want to tell it some day, but it will take some time...\n\nHey you! <b>Wow</b>! Thanks for reading up to here! You're <em>awesome</em>. If you left the speed to 150 words per minute, it will have taken you about five and a half minutes. It will have take you a lot less than that if you increased the reading speed. Want to know exactly how much of your time I have taken? And how much words were in this piece of text? Hit the {.} (dot) or {,} (comma) key after WordyWordy has given its smile and you'll see the nerdy stats."
    };
    if (!(rParams.text) && rParams.canned && rCannedTexts[rParams.canned]){
      words.init(rCannedTexts[rParams.canned]);
      displayWord(words.getCurrentWord());
      updateTimeToGo();
      rDocumentTitle = rParams.canned;
    }
}();
    </script>
</html>
